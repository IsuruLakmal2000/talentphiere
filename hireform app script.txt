// Google Apps Script for TalentPhere Hire Form with Email Notifications
// Replace with your actual Google Sheet ID and Admin Email
const SPREADSHEET_ID = '1LVwgTlXObSPK9ztfQsWQdlZn9O3jrYlIQSESdFE11FM';
const ADMIN_EMAIL = 'info.talentphere@gmail.com';
const SHEET_NAME = 'Hire Form Submissions'; // Name of the sheet tab

/**
 * Handle POST requests (form submissions)
 */
function doPost(e) {
  try {
    // Parse the JSON data from the request
    const data = JSON.parse(e.postData.contents);
    
    // Get or create the sheet
    const sheet = getOrCreateSheet();
    
    // Create headers if this is the first entry
    if (sheet.getLastRow() === 0) {
      createHeaders(sheet);
    }
    
    // Append the form data
    appendFormData(sheet, data);
    
    // Send email notification
    if (ADMIN_EMAIL !== 'info.talentphere@gmail.com') {
      sendEmailNotification(data);
    }
    
    // Return success response
    return ContentService
      .createTextOutput(JSON.stringify({
        success: true,
        message: 'Form submitted successfully! We will contact you soon.',
        timestamp: new Date().toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
      
  } catch (error) {
    // Log the error
    console.error('Error processing hire form submission:', error);
    
    // Return error response
    return ContentService
      .createTextOutput(JSON.stringify({
        success: false,
        message: 'Error processing submission',
        error: error.toString(),
        timestamp: new Date().toISOString()
      }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Handle GET requests (for testing)
 */
function doGet(e) {
  return ContentService
    .createTextOutput(JSON.stringify({
      status: 'TalentPhere Hire Form API is running',
      timestamp: new Date().toISOString(),
      message: 'Use POST method to submit form data',
      expectedFields: [
        'firstName',
        'lastName', 
        'workEmail',
        'companyName',
        'companyWebsite',
        'yourTitle',
        'industry',
        'howDidYouHear',
        'lookingFor (array)'
      ]
    }))
    .setMimeType(ContentService.MimeType.JSON);
}

/**
 * Get or create the hire form sheet
 */
function getOrCreateSheet() {
  const ss = SpreadsheetApp.openById(SPREADSHEET_ID);
  let sheet = ss.getSheetByName(SHEET_NAME);
  
  if (!sheet) {
    sheet = ss.insertSheet(SHEET_NAME);
  }
  
  return sheet;
}

/**
 * Create header row
 */
function createHeaders(sheet) {
  const headers = [
    'Timestamp',
    'First Name',
    'Last Name',
    'Work Email',
    'Company Name',
    'Company Website',
    'Your Title',
    'Industry',
    'How Did You Hear',
    'Looking For'
  ];
  
  sheet.appendRow(headers);
  
  // Format header row
  const headerRange = sheet.getRange(1, 1, 1, headers.length);
  headerRange.setFontWeight('bold');
  headerRange.setBackground('#2c5f7a');
  headerRange.setFontColor('#ffffff');
  headerRange.setHorizontalAlignment('center');
  
  // Freeze header row
  sheet.setFrozenRows(1);
  
  // Set column widths
  sheet.setColumnWidth(1, 150); // Timestamp
  sheet.setColumnWidth(2, 120); // First Name
  sheet.setColumnWidth(3, 120); // Last Name
  sheet.setColumnWidth(4, 200); // Work Email
  sheet.setColumnWidth(5, 180); // Company Name
  sheet.setColumnWidth(6, 200); // Company Website
  sheet.setColumnWidth(7, 150); // Your Title
  sheet.setColumnWidth(8, 150); // Industry
  sheet.setColumnWidth(9, 180); // How Did You Hear
  sheet.setColumnWidth(10, 250); // Looking For
}

/**
 * Append form data to sheet
 */
function appendFormData(sheet, data) {
  const timestamp = new Date();
  
  // Prepare row data based on the hire form structure
  const rowData = [
    timestamp,
    // Step 1 data
    data.firstName || '',
    data.lastName || '',
    data.workEmail || '',
    // Step 2 data
    data.companyName || '',
    data.companyWebsite || '',
    data.yourTitle || '',
    data.industry || '',
    data.howDidYouHear || '',
    Array.isArray(data.lookingFor) ? data.lookingFor.join(', ') : (data.lookingFor || '')
  ];
  
  // Add the row to the sheet
  sheet.appendRow(rowData);
  
  // Format the new row
  const lastRow = sheet.getLastRow();
  const range = sheet.getRange(lastRow, 1, 1, rowData.length);
  
  // Alternate row colors
  if (lastRow % 2 === 0) {
    range.setBackground('#f5f5f5');
  }
}

/**
 * Send email notification to admin
 */
function sendEmailNotification(data) {
  try {
    const subject = `New Hire Form Submission: ${data.companyName} - ${data.firstName} ${data.lastName}`;
    
    const body = `
New Hire Form Submission Received
=================================

CONTACT INFORMATION:
--------------------
Name: ${data.firstName} ${data.lastName}
Work Email: ${data.workEmail}

COMPANY INFORMATION:
--------------------
Company Name: ${data.companyName}
Company Website: ${data.companyWebsite || 'Not provided'}
Your Title: ${data.yourTitle}
Industry: ${data.industry}

ADDITIONAL DETAILS:
-------------------
How Did You Hear About Us: ${data.howDidYouHear}
Looking For: ${Array.isArray(data.lookingFor) ? data.lookingFor.join(', ') : data.lookingFor}

=================================
Submitted: ${new Date().toLocaleString()}

View all hire form submissions: ${SpreadsheetApp.openById(SPREADSHEET_ID).getUrl()}
    `;
    
    // Send email notification
    MailApp.sendEmail({
      to: ADMIN_EMAIL,
      subject: subject,
      body: body
    });
    
    Logger.log('Email notification sent for hire form submission: ' + data.companyName);
  } catch (error) {
    console.error('Error sending email notification:', error);
    // Don't throw error - form submission should still succeed even if email fails
  }
}

/**
 * Test function - Run this to test the script
 */
function testHireFormScript() {
  const testData = {
    firstName: 'John',
    lastName: 'Smith',
    workEmail: 'john.smith@company.com',
    companyName: 'Tech Innovations Inc.',
    companyWebsite: 'https://techinnovations.com',
    yourTitle: 'CEO',
    industry: 'Technology',
    howDidYouHear: 'Google Search',
    lookingFor: ['Executive Assistant', 'Development & Innovation']
  };
  
  const mockEvent = {
    postData: {
      contents: JSON.stringify(testData)
    }
  };
  
  const result = doPost(mockEvent);
  Logger.log(result.getContent());
}

/* 
SETUP INSTRUCTIONS:
===================

1. GOOGLE SHEET SETUP:
   - Make sure your Google Sheet has a tab named "Hire Form Submissions" (or update SHEET_NAME variable)
   - Headers will be created automatically on first submission

2. EMAIL SETUP:
   - Update ADMIN_EMAIL with your actual admin email address
   - The script will send notifications to this email for each submission

3. DEPLOYMENT:
   - Save this script in Google Apps Script
   - Click "Deploy" > "New deployment"
   - Select type: "Web app"
   - Execute as: "Me"
   - Who has access: "Anyone"
   - Click "Deploy"
   - Copy the Web App URL
   - Update the HIRE_FORM_SCRIPT_URL in your React app's googleSheets.ts file

4. PERMISSIONS:
   - The first time you run this script, it will ask for permissions to:
     - Access Google Sheets
     - Send emails
   - Grant these permissions for the script to work properly

5. TESTING:
   - Run the testHireFormScript() function to test the script
   - Check if the data appears in your Google Sheet
   - Check if you receive the email notification
*/
